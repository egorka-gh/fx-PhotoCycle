/**
 * Generated by Gas3 v2.3.2 (Granite Data Services).
 *
 * NOTE: this file is only generated if it does not exist. You may safely put
 * your custom code here.
 */

package com.photodispatcher.model.mysql.entities {
	import com.photodispatcher.provider.fbook.FBookProject;
	import com.photodispatcher.provider.fbook.model.PageData;
	
	import flash.globalization.DateTimeStyle;
	
	import mx.collections.ArrayList;
	import mx.formatters.DateFormatter;
	
	import spark.components.gridClasses.GridColumn;
	import spark.formatters.DateTimeFormatter;

    [Bindable]
    [RemoteClass(alias="com.photodispatcher.model.mysql.entities.SubOrder")]
    public class SubOrder extends SubOrderBase {
		
		//runtime
		public  var projectIds:Array=[];
		//public  var project:FBookProject;
		public  var projects:Array=[];
		public  var native_type:int=-1;
		
		private var _log:String;
		public function get log():String{
			return _log;
		} 
		public function set log(value:String):void{
			var dt:Date= new Date();
			var df:DateFormatter = new DateFormatter();
			df.formatString='DD.MM.YY J:NN:SS';
			if(_log){
				_log=_log +'\n'+ df.format(dt)+': '+value;
			}else{
				_log =df.format(dt)+': '+value;
			}
		}
		public function resetlog():void{
			_log ='';
		}

		
		public function SubOrder(){
			super();
			state=OrderState.FTP_WAITE_SUBORDER;
			proj_type=1;
			prt_qty=1;

		}
		
		override public function set sub_id(value:String):void{
			super.sub_id = value;
			fillId();
		}
		override public function get sub_id():String{
			return super.sub_id;
		}
		
		public function get humanId():String{
			var res:String=order_id;
			if(sub_id) res=res+':'+sub_id;
			return res;
		}
		
		public function fillId():void{
			//id=order_id+'.'+src_id;
			//ftp_folder='fb'+sub_id;
			if(native_type!=1 && !ftp_folder) ftp_folder='fb'+sub_id; //foto proj, holds order root ftp_folder 
		}

		public function clone():SubOrder{
			var result:SubOrder= new SubOrder;
			//result.ftp_folder=ftp_folder;
			result.order_id=order_id;
			result.sub_id=sub_id;
			result.src_type=src_type;
			result.src_type_name=src_type_name;
			result.proj_type=proj_type;
			result.proj_type_name=proj_type_name;
			//extra
			if(extraInfo){
				result.extraInfo= new OrderExtraInfo();
				result.extraInfo.calc_type=extraInfo.calc_type;
				result.extraInfo.corner_type=extraInfo.corner_type;
				result.extraInfo.cover=extraInfo.cover;
				result.extraInfo.endpaper=extraInfo.endpaper;
				result.extraInfo.format=extraInfo.format;
				result.extraInfo.interlayer=extraInfo.interlayer;
				result.extraInfo.kaptal=extraInfo.kaptal;
			}
			return result;
		}

		public function get isMultibook():Boolean{
			if((projectIds && projectIds.length>1) || (projects && projects.length>1)) return true;
			return false;
		}
		
		public function get referenceProject():FBookProject{
			var project:FBookProject;
			if (projects && projects.length>0) project=projects[0] as FBookProject;
			return project;
		}
		
		/***
		 * valid after fetching all projects from site
		***/
		public function get books_num():int{
			var result:int=prt_qty;
			if(isMultibook){
				result=projects.length;
			}
			return result;
		}

		/***
		 * valid after generating all IM scripts
		 * retuns sheets number for body
		 * 4 cover use book_num (1 cover per book)
		 ***/
		public function get sheets_num():int{
			var result:int=0;
			var project:FBookProject=referenceProject;
			if(!project) return result;
			var page:PageData;
			for each(page in project.projectPages){
				if(page) result=Math.max(result,page.sheetNum);
			}
			return result;
		}
		
		public function destroyChilds():void{
			if(!projects || projects.length==0) return;
			var project:FBookProject;
			for each(project in projects){
				project.destroyChilds();
			}
			projects=[];
		}
		
		public function toRaw():Object{
			//serialize props 4 build only 
			var raw:Object= new Object;
		
			/*
			//raw.id=id;
			raw.order_id=order_id;
			raw.sub_id=sub_id;
			raw.src_type=src_type;
			raw.proj_type=proj_type;
			raw.prt_qty=prt_qty;
			raw.alias=alias;
			
			//extra
			if(extraInfo){
				raw.calc_type=extraInfo.calc_type;
				raw.corner_type=extraInfo.corner_type;
				raw.cover=extraInfo.cover;
				raw.endpaper=extraInfo.endpaper;
				raw.format=extraInfo.format;
				raw.interlayer=extraInfo.interlayer;
				raw.kaptal=extraInfo.kaptal;
			}
			
			if(project) raw.project=project.toRaw();
			*/
			return raw;
		}
		
		public static function fromRaw(raw:Object):SubOrder{
			return null;
			/*
			if(!raw) return null;
			var suborder:SubOrder= new SubOrder();
			//suborder.id=raw.id;
			suborder.order_id=raw.order_id;
			suborder.sub_id=raw.sub_id;
			suborder.src_type=raw.src_type;
			suborder.proj_type=raw.proj_type;
			suborder.prt_qty=raw.prt_qty;
			suborder.alias=raw.alias;
			//extra
			suborder.extraInfo= new OrderExtraInfo();
			suborder.extraInfo.calc_type=raw.calc_type;
			suborder.extraInfo.corner_type=raw.corner_type;
			suborder.extraInfo.cover=raw.cover;
			suborder.extraInfo.endpaper=raw.endpaper;
			suborder.extraInfo.format=raw.format;
			suborder.extraInfo.interlayer=raw.interlayer;
			suborder.extraInfo.kaptal=raw.kaptal;
			
			suborder.project=FBookProject.fromRaw(raw.project);
			return suborder;
			*/
		}
		
		public static function gridColumns():ArrayList{
			var result:Array= [];
			var col:GridColumn;
			
			col= new GridColumn('sub_id'); col.headerText='ID'; col.width=80; result.push(col);
			col= new GridColumn('src_type_name'); col.headerText='Тип источника'; result.push(col);
			col= new GridColumn('proj_type_name'); col.headerText='Тип книги'; result.push(col);
			col= new GridColumn('alias'); col.headerText='Алиас'; result.push(col); 
			col= new GridColumn('ftp_folder'); col.headerText='Папка'; result.push(col);
			col= new GridColumn('prt_qty'); col.headerText='Кол-во'; result.push(col);
			/*
			col= new GridColumn('extraInfo.calc_type'); col.headerText='Тип'; result.push(col);
			col= new GridColumn('extraInfo.cover'); col.headerText='Обложка'; result.push(col);
			col= new GridColumn('extraInfo.format'); col.headerText='Формат'; result.push(col);
			col= new GridColumn('extraInfo.endpaper'); col.headerText='Форзац'; result.push(col);
			col= new GridColumn('extraInfo.interlayer'); col.headerText='Прослойка'; result.push(col);
			col= new GridColumn('extraInfo.corner_type'); col.headerText='Углы'; result.push(col);
			col= new GridColumn('extraInfo.kaptal'); col.headerText='Каптал'; result.push(col);
			*/
			
			return new ArrayList(result);
		}

		public static function gridColumnsOTK():ArrayList{
			var result:Array= [];
			var col:GridColumn;
			col= new GridColumn('order_id'); col.headerText='Заказ';  col.width=150; result.push(col);
			col= new GridColumn('sub_id'); col.headerText='Под заказ';  col.width=150; result.push(col);
			var fmt:DateTimeFormatter=new DateTimeFormatter(); fmt.dateStyle=fmt.timeStyle=DateTimeStyle.SHORT;
			col= new GridColumn('state_date'); col.headerText='Начат'; col.formatter=fmt; col.width=150; result.push(col);
			col= new GridColumn('prt_qty'); col.headerText='Всего книг'; col.width=100; result.push(col);
			col= new GridColumn('books_done'); col.headerText='Выполнено'; col.width=100; result.push(col);
			return new ArrayList(result);
		}

		
    }
}
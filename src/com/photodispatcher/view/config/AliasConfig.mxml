<?xml version="1.0" encoding="utf-8"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009" 
		 xmlns:s="library://ns.adobe.com/flex/spark" 
		 xmlns:mx="library://ns.adobe.com/flex/mx"
		 creationComplete="{init()}" xmlns:config="com.photodispatcher.view.config.*"
		 >
	<fx:Script>
		<![CDATA[
			import com.photodispatcher.model.mysql.DbLatch;
			import com.photodispatcher.model.mysql.entities.AliasForward;
			import com.photodispatcher.model.mysql.services.ConfigService;
			
			import mx.collections.ArrayCollection;
			
			import org.granite.tide.Tide;
			
			[Bindable]
			private var aliasAC:ArrayCollection;
			[Bindable]
			private var currItem:Object;

			private var cfgService:ConfigService;

			private function init():void{

				cfgService=Tide.getInstance().getContext().byType(ConfigService,true) as ConfigService;

				var initLatch:DbLatch= new DbLatch();

				initLatch.join(loadAlias());
				
				initLatch.addEventListener(Event.COMPLETE, onInitComplite);
				initLatch.start();

			}
			
			private function onInitComplite(event:Event):void{
				var latch:DbLatch= event.target as DbLatch;
				if(latch){
					latch.removeEventListener(Event.COMPLETE,onInitComplite);
					if(latch.complite){
						
					}
				}
			}
			
			private function loadAlias():DbLatch{
				var latch:DbLatch= new DbLatch();
				latch.addEventListener(Event.COMPLETE, onStaffLoad);
				latch.addLatch(cfgService.loadAliasForward());
				latch.start();
				return latch;
			}
			private function onStaffLoad(event:Event):void{
				var latch:DbLatch= event.target as DbLatch;
				currItem=null;
				if(latch){
					latch.removeEventListener(Event.COMPLETE,onStaffLoad);
					if(latch.complite){
						aliasAC=latch.lastDataAC;
					}else{
						aliasAC=null;
					}
				}
			}

			

			protected function btAddStaff_clickHandler(event:MouseEvent):void{
				var it:AliasForward= new AliasForward();
				aliasAC.addItem(it);
				currItem=it;
			}
			
			protected function btSaveStaff_clickHandler(event:MouseEvent):void{
				var items:ArrayCollection= new ArrayCollection();
				var it:AliasForward;
				for each(it in aliasAC){
					if (it.changed || (!it.loaded && it.alias) ) items.addItem(it);
				}
				if(items.length==0) return;
				var latch:DbLatch=new DbLatch();
				latch.addEventListener(Event.COMPLETE, onStaffSave);
				latch.addLatch(cfgService.persistAliasForward(items));
				latch.start();
			}
			private function onStaffSave(event:Event):void{
				var latch:DbLatch= event.target as DbLatch;
				if(latch){
					latch.removeEventListener(Event.COMPLETE,onStaffSave);
					loadAlias();
				}
			}


		]]>
	</fx:Script>
	
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	
	<s:HGroup width="100%" height="100%" gap="5" paddingLeft="10">
		<s:VGroup width="400" height="100%" gap="10">
			<s:Label text="Не производственные алиасы"/>
			<config:ItemsGrid id="aliasGrid" editable="true" 
							  currentData="{aliasAC}"
							  currentColumns="{AliasForward.gridColumns()}"
							  currentItem="@{currItem}"
							  width="100%"
							  height="100%"/>
			<s:HGroup width="100%" gap="5" horizontalAlign="right">
				<s:Button id="btAddStaff" label="Добавить" click="btAddStaff_clickHandler(event)"/>
				<s:Button id="btSaveStaff" label="Сохранить" click="btSaveStaff_clickHandler(event)"/>
			</s:HGroup>
		</s:VGroup>
	</s:HGroup>
	
</s:Group>

<?xml version="1.0" encoding="utf-8"?>
<s:SkinnablePopUpContainer xmlns:fx="http://ns.adobe.com/mxml/2009" 
						   xmlns:s="library://ns.adobe.com/flex/spark" 
						   xmlns:mx="library://ns.adobe.com/flex/mx" 
						   width="800" height="600">
	
	<fx:Script>
		<![CDATA[
			import com.photodispatcher.context.Context;
			import com.photodispatcher.factory.WebServiceBuilder;
			import com.photodispatcher.model.mysql.entities.MailPackage;
			import com.photodispatcher.model.mysql.entities.MailPackageProperty;
			import com.photodispatcher.model.mysql.entities.Source;
			import com.photodispatcher.service.web.BaseWeb;
			
			import mx.controls.Alert;
			import mx.core.FlexGlobals;
			import mx.managers.PopUpManager;
			
			[Bindable]
			private var stateMsg:String;
			
			[Bindable]
			public var mailPackage:MailPackage;
			
			private var source:Source;
			
			public function loadFromWeb(sourceId:int, id:int):void{
				mailPackage=null;
				stateMsg='Загрузка с сайта';
				source=Context.getSource(sourceId);
				if(!source){
					stateMsg=stateMsg+'. Ошибка инициализации, не найден источник '+sourceId.toString();
					Alert.show(stateMsg);
					return;
				}
				var w:BaseWeb= WebServiceBuilder.build(source);
				w.addEventListener(Event.COMPLETE,webHandler);
				try{
					w.getMailPackage(id);
				}catch(error:Error){
					Alert.show('Ошибка web сервиса '+source.name+': '+error.message );
					return;
				}
				show();
			}
			
			private function show():void{
				this.open((FlexGlobals.topLevelApplication as DisplayObjectContainer),true);
				this.width=FlexGlobals.topLevelApplication.width-50;
				this.height=FlexGlobals.topLevelApplication.height-100;
				PopUpManager.centerPopUp(this);

			}
			
			private function webHandler(e:Event):void{
				var pw:BaseWeb=e.target as BaseWeb;
				pw.removeEventListener(Event.COMPLETE,webHandler);
				
				if(pw.hasError){
					trace('web getMailPackage err: '+pw.errMesage);
					stateMsg='Ошибка загрузки с сайта: '+pw.errMesage;
					return;
				}
				mailPackage=pw.getLastMailPackage();
			}

		]]>
	</fx:Script>
	
	<fx:Declarations>
		<s:DateTimeFormatter id="dtFormater" dateTimePattern="dd.MM.yyyy HH:mm"/>
	</fx:Declarations>

	
	<s:VGroup width="100%" height="100%" gap="5">
		<s:Label text="{stateMsg}" width="100%"/>
		
		<s:Spacer height="5"/>
		<s:Form id="frmOrder" backgroundAlpha="0" >
			<s:layout>
				<s:FormLayout gap="-12"/>
			</s:layout>
			
			<s:FormItem label="ID">
				<s:TextInput id="tiID" text="{mailPackage.id_name} ({mailPackage.id})" width="200"/>
			</s:FormItem> 
			<s:FormItem label="Источник">
				<s:TextInput  text="{mailPackage.source_name}" width="200"/>
			</s:FormItem> 
			<s:FormItem label="Доставка">
				<s:TextInput  text="{mailPackage.delivery_name}" width="200"/>
			</s:FormItem> 
			<s:FormItem label="Срок исполнения">
				<s:TextInput  text="{dtFormater.format(mailPackage.execution_date)}" width="200"/>
			</s:FormItem> 
			<s:FormItem label="Кол заказов">
				<s:TextInput  text="{mailPackage.orders_num.toString()}" width="200"/>
			</s:FormItem> 
		</s:Form>

		<s:Spacer height="5"/>
		<s:HGroup width="100%" height="100%" gap="10">
			<s:VGroup width="50%" height="100%" gap="5">
				<s:Label text="Атрибуты"/>
				<s:DataGrid id="dgAtrs" selectionMode="singleRow" width="100%" height="100%" 
							dataProvider="{mailPackage.properties}" locale="ru_RU" columns="{MailPackageProperty.gridColumns()}"/>
			</s:VGroup>
			<s:VGroup width="50%" height="100%" gap="5">
				<s:Label text="Заказы"/>
				<s:DataGrid id="dgAtrs" selectionMode="singleRow" width="100%" height="100%" 
							dataProvider="{mailPackage.properties}" locale="ru_RU" columns="{MailPackageProperty.gridColumns()}"/>
				<s:Spacer height="5"/>
				<s:Label text="Штрих коды"/>
			</s:VGroup>
		</s:HGroup>

		<s:Spacer height="5"/>
		<s:HGroup width="100%" horizontalAlign="right">
			<s:Button id="btClose" label="Закрыть" click="{close()}"/>
		</s:HGroup>
	</s:VGroup>
</s:SkinnablePopUpContainer>
